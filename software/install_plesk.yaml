- hosts: localhost
  become: true
  vars:
    plesk_email: "admin@example.com"
    plesk_password: "P@ssw0rd"
    php_modules:
      - php7.4-mysql
      - php7.4-curl
      - php7.4-gd
      - php7.4-intl
      - php7.4-imap
      - php7.4-xml
      - php7.4-mbstring
      - php7.4-zip
  tasks:
    - name: Actualizar la lista de paquetes
      apt: update_cache=yes

    - name: Instalar wget
      apt:
        name: wget
        state: present

    - name: Descargar el instalador de Plesk
      get_url:
        url: https://autoinstall.plesk.com/plesk-installer
        dest: /tmp/plesk-installer
        mode: 'u+x'

    - name: Instalar Plesk
      command: /tmp/plesk-installer --web-interface --all-features --admin_password={{ plesk_password }} --admin_email={{ plesk_email }}

    - name: Instalar m√≥dulos de PHP
      apt:
        name: "{{ php_modules }}"
        state: present

    - name: Instalar Postfix
      apt:
        name: postfix
        state: present

    - name: Configurar Plesk
      shell: |
        plesk bin settings --set panel_ini_components=all
        plesk bin poweruser --off
        plesk bin mail --off
        plesk bin autoresponder --off
        plesk bin spamassassin --off
        plesk bin antivirus --off
        plesk bin mail_auth_view --off
        plesk bin dns --off
        plesk bin smarthost --off
        plesk bin mchk --with-spam
        plesk bin extension --install-url https://ext.plesk.com/packages/c4abeef6-16a6-4a08-bc12-c68a4dee4139-panel-landing-page/download --force